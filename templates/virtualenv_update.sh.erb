#!/usr/bin/env bash

# Fetch latest code from master
cd /var/www/html/TWLight
git pull origin <%= @twlight_git_revision %>

# Activate Django virtualenv and update pip dependencies
cd /home/<%= @twlight_unixname %>
virtualenv TWLight
source /home/<%= @twlight_unixname %>/TWLight/bin/activate
export DJANGO_SETTINGS_MODULE=TWLight.settings.<%= @twlight_environment %>
pip install -r /var/www/html/TWLight/requirements/wmf.txt

# Run migrations
cd /var/www/html/TWLight
echo "migrate"
python manage.py migrate
echo "createinitialrevisions"
python manage.py createinitialrevisions
echo "makemigrations"
python manage.py makemigrations
echo "migrate"
python manage.py migrate

# Compile translations
echo "makemessages"
langs=($(python manage.py diffsettings | grep 'LANGUAGES' | grep -o "'[^']*'" | xargs))
for locale in "${langs[@]}"; do
  python manage.py makemessages --locale=${locale};
done
python manage.py makemessages --locale=qqq

echo "compilemessages"
python manage.py compilemessages
echo "collectstatic --noinput"
python manage.py collectstatic --noinput
