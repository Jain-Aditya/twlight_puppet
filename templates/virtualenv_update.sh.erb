#!/bin/bash

# Bail if gunicorn is running
systemctl is-active gunicorn >/dev/null 2>&1 && exit 1;

# Fetch latest code from master
cd /var/www/html/TWLight
git pull origin <%= @twlight_git_revision %>

# Update Django
source /home/<%= @twlight_unixname %>/TWLight/bin/activate
export DJANGO_SETTINGS_MODULE=TWLight.settings.<%= @twlight_environment %>
pip install -r /var/www/html/TWLight/requirements/wmf.txt
<%if @twlight_environment != 'production' -%>
pip install -r /var/www/html/TWLight/requirements/test.txt
<% end -%>
echo "migrate"
python manage.py migrate

# Compile translations
echo "makemessages"
langs=($(python manage.py diffsettings | grep 'LANGUAGES' | grep -o "'[^']*'" | xargs))
for locale in "${langs[@]}"; do
  python manage.py makemessages --locale=${locale};
done
python manage.py makemessages --locale=qqq

echo "compilemessages"
python manage.py compilemessages
echo "collectstatic --noinput"
python manage.py collectstatic --noinput
