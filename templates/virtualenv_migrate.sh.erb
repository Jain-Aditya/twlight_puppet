#!/usr/bin/env bash

source <%= @twlight_root_dir %>/bin/virtualenv_activate.sh

# Run migrations
echo "migrate"
python manage.py createinitialrevisions
python manage.py makemigrations
python manage.py sync_translation_fields --noinput
python manage.py migrate
apps=($(python manage.py diffsettings | grep 'TWLIGHT_APPS' | grep -o "'[^']*'" | xargs))
for path in "${apps[@]}"; do
  # Strip 'TWLight.' from the front of each TWLIGHT_APP
  app=${path:8}
  # skip emails, graphs, and i18n
  if [ "${app}" = "emails" ] || [ "${app}" = "graphs" ] || [ "${app}" = "i18n" ]; then
    continue
  fi
  echo "createinitialrevisions ${app}"
  python manage.py createinitialrevisions ${app};
  echo "makemigrations ${app}"
  python manage.py makemigrations ${app};
  echo "migrate ${app}"
  python manage.py migrate ${app};
done
